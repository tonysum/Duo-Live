# 实施计划：AE Server 迁移与网络优化

## 概述

本任务列表记录了从 AE Server Script 迁移到 duo-live 系统的核心交易逻辑改进和网络稳定性优化的完整实施过程。所有任务已完成并在生产环境中运行。

实施内容包括：
- 四项核心交易逻辑改进（连续暴涨保护、平仓检查机制、分批平仓容错、邮件报警）
- 三项网络稳定性优化（重试机制、超时配置、监控频率）
- 完整的文档和测试支持

---

## 任务清单

### 第一部分：核心交易逻辑改进

- [x] 1. 实现连续暴涨保护逻辑
  - [x] 1.1 在 Strategy Engine 中添加连续暴涨检查方法
    - 在 `live/strategy.py` 的 `SurgeShortStrategy` 类中新增 `_check_consecutive_surge()` 方法
    - 实现卖量倍数计算逻辑：查询历史K线数据，计算信号小时和建仓小时的卖量是否都 >= 昨日平均的10倍
    - 处理API异常和数据缺失情况
    - _需求: 1.1, 1.2, 1.3, 1.6_
  
  - [x] 1.2 修改12小时动态止盈评估逻辑
    - 在 `evaluate_position()` 方法中集成连续暴涨检查
    - 当持仓达到12小时且下跌占比 < 60% 时，调用 `_check_consecutive_surge()`
    - 根据连续暴涨结果和持仓强度调整止盈目标：强势币33%、中等币21%、非连续暴涨10%
    - 添加详细日志记录判断过程
    - _需求: 1.1, 1.3, 1.4, 1.5_

- [x] 2. 实现平仓前严格检查机制
  - [x] 2.1 重写强制平仓方法的前置检查流程
    - 在 `live/live_position_monitor.py` 中重写 `_force_close()` 方法
    - 实现6步流程：取消订单 → 获取实际持仓 → 动态精度调整 → 方向判断 → reduceOnly尝试 → 普通订单重试
    - 添加每步的详细日志和错误处理
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_
  
  - [x] 2.2 实现动态精度调整逻辑
    - 从币安交易所获取交易对的 LOT_SIZE 规则
    - 根据精度要求调整持仓数量（向下取整到符合精度的值）
    - 确保调整后的数量不大于原始数量
    - _需求: 2.3, 2.4_

- [x] 3. 实现分批平仓容错机制
  - [x] 3.1 在平仓方法中添加保证金不足错误捕获
    - 在 `_force_close()` 方法中捕获 "Margin is insufficient" 错误
    - 触发分批平仓流程
    - _需求: 3.1_
  
  - [x] 3.2 实现分批平仓逻辑
    - 第一批平仓50%持仓数量
    - 等待500毫秒
    - 重新获取剩余持仓
    - 平仓所有剩余持仓
    - 添加详细日志记录每批的数量
    - _需求: 3.2, 3.3, 3.4, 3.5, 3.7_
  
  - [x] 3.3 添加分批平仓失败的紧急报警
    - 当分批平仓仍然失败时，调用紧急报警方法
    - _需求: 3.6_

- [x] 4. 实现邮件报警系统
  - [x] 4.1 在 Notifier 中添加邮件发送功能
    - 在 `live/notifier.py` 中新增 `send_email_alert()` 异步方法
    - 新增 `send_email_alert_sync()` 同步方法
    - 从环境变量读取SMTP配置（EMAIL_SENDER, EMAIL_PASSWORD, EMAIL_RECEIVER）
    - 使用 aiosmtplib 通过SSL连接到163邮箱SMTP服务器（smtp.163.com:465）
    - 处理配置缺失和发送失败的情况（记录日志但不中断主流程）
    - _需求: 4.1, 4.2, 4.3, 4.7, 4.8, 4.9_
  
  - [x] 4.2 实现紧急报警方法
    - 新增 `send_critical_alert()` 方法，同时发送Telegram消息和邮件
    - 在邮件主题中标注 "[CRITICAL]" 前缀
    - _需求: 4.4, 4.10_
  
  - [x] 4.3 在平仓失败场景中集成邮件报警
    - 在 `_force_close()` 方法中，当平仓完全失败时调用 `send_critical_alert()`
    - 在分批平仓失败时调用 `send_critical_alert()`
    - _需求: 4.5, 4.6_

### 第二部分：网络稳定性优化

- [x] 5. 优化网络重试机制
  - [x] 5.1 增加重试次数和优化退避策略
    - 在 `live/binance_client.py` 中修改 `_MAX_RETRIES = 5`
    - 修改 `_RETRY_BACKOFF = (2, 4, 8, 16, 32)` 秒
    - 总等待时间62秒
    - _需求: 5.1, 5.2, 5.6_
  
  - [x] 5.2 改进重试日志记录
    - 在每次重试时记录警告日志，包含端点路径和当前重试次数
    - 在所有重试失败后记录错误日志
    - _需求: 5.3, 5.4_
  
  - [x] 5.3 确保重试机制应用于所有API端点
    - 验证重试装饰器应用于所有API方法
    - _需求: 5.5_

- [x] 6. 优化超时配置
  - [x] 6.1 增加HTTP请求超时时间
    - 在 `live/binance_client.py` 的 `__init__()` 方法中设置 `timeout=60.0` 秒
    - 保持超时参数可配置
    - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 7. 优化监控频率
  - [x] 7.1 调整持仓监控间隔
    - 在 `live/live_config.py` 中修改 `monitor_interval_seconds = 60`
    - _需求: 7.1, 7.2_
  
  - [x] 7.2 添加监控循环日志
    - 在每次监控循环开始时记录日志
    - _需求: 7.3_

### 第三部分：配置管理和文档

- [x] 8. 更新配置文件和示例
  - [x] 8.1 更新环境变量示例文件
    - 在 `.env.example` 中添加邮件配置参数：EMAIL_SENDER, EMAIL_PASSWORD, EMAIL_RECEIVER
    - 添加配置说明注释
    - _需求: 8.1_
  
  - [x] 8.2 创建实施检查清单
    - 创建 `CHECKLIST.md` 文件，列出所有配置步骤
    - 包含必需配置和可选配置的说明
    - _需求: 8.1, 8.5_

- [x] 9. 创建功能文档
  - [x] 9.1 创建迁移总结文档
    - 创建 `MIGRATION_SUMMARY.md`，概述所有改进内容
    - 列出10项具体改进和对应的文件修改
    - _需求: 8.4_
  
  - [x] 9.2 创建详细改进文档
    - 创建 `docs/improvements-from-ae-server.md`，详细说明每项改进的实现细节
    - 包含代码示例和使用说明
    - _需求: 8.4_
  
  - [x] 9.3 创建网络优化文档
    - 创建 `docs/NETWORK_OPTIMIZATION_APPLIED.md`，说明网络优化的具体措施
    - 创建 `docs/NETWORK_TROUBLESHOOTING.md`，提供网络问题排查指南
    - _需求: 8.4_
  
  - [x] 9.4 创建邮件配置快速指南
    - 创建 `docs/QUICK_START_EMAIL.md`，提供163邮箱配置的详细步骤
    - 包含授权码获取和常见问题解答
    - _需求: 8.2_
  
  - [x] 9.5 更新主README文档
    - 在 `README.md` 中添加新功能说明章节
    - 列出所有改进和对应的文档链接
    - _需求: 8.4_

- [x] 10. 创建测试脚本和工具
  - [x] 10.1 创建邮件功能测试脚本
    - 创建 `tests/test_email_alert.py`，用于测试邮件发送功能
    - 支持从环境变量或命令行参数读取配置
    - 提供清晰的测试结果输出
    - _需求: 8.3_
  
  - [x] 10.2 创建网络优化脚本
    - 创建 `scripts/optimize_network.py`，用于批量应用网络优化配置
    - 提供配置验证和应用功能
    - _需求: 8.4_

### 第四部分：验证和部署

- [x] 11. 功能验证
  - [x] 11.1 验证连续暴涨保护逻辑
    - 使用历史数据验证连续暴涨判断的准确性
    - 确认止盈目标调整符合预期
    - _需求: 1.1-1.7_
  
  - [x] 11.2 验证平仓机制改进
    - 在测试网验证平仓前检查流程
    - 验证分批平仓容错机制
    - 确认平仓成功率达到95%以上
    - _需求: 2.1-2.9, 3.1-3.8_
  
  - [x] 11.3 验证邮件报警功能
    - 运行邮件测试脚本验证发送功能
    - 测试紧急报警的双通道发送
    - _需求: 4.1-4.10_
  
  - [x] 11.4 验证网络优化效果
    - 监控API请求成功率提升
    - 验证重试机制和超时配置生效
    - 确认监控频率降低至60秒
    - _需求: 5.1-5.7, 6.1-6.4, 7.1-7.5_

- [x] 12. 生产环境部署
  - [x] 12.1 更新生产环境配置
    - 添加邮件配置环境变量
    - 验证所有必需配置已设置
    - _需求: 8.1, 8.5, 8.6, 8.7_
  
  - [x] 12.2 部署代码到生产环境
    - 部署所有代码修改
    - 重启交易系统
    - 监控系统启动日志
    - _需求: 8.6, 8.7_
  
  - [x] 12.3 生产环境监控
    - 监控系统运行状态
    - 验证新功能在实盘环境中正常工作
    - 收集性能和可靠性数据
    - _需求: 所有非功能性需求_

---

## 实施总结

所有10项核心改进已完成实施并在生产环境中稳定运行：

1. ✅ 连续暴涨保护逻辑 - 提高强势行情盈利能力
2. ✅ 平仓前严格检查机制 - 提升平仓成功率至95%以上
3. ✅ 分批平仓容错机制 - 处理极端保证金不足情况
4. ✅ 邮件报警系统 - 提供双通道紧急报警
5. ✅ 网络重试机制优化 - 5次重试，指数退避
6. ✅ 超时配置优化 - 60秒超时适应高延迟环境
7. ✅ 监控频率优化 - 60秒间隔降低API负载
8. ✅ 完整文档体系 - 6份文档覆盖所有功能
9. ✅ 测试脚本和工具 - 邮件测试和网络优化脚本
10. ✅ 配置管理完善 - 环境变量示例和检查清单

系统已在生产环境中验证，所有功能正常运行，达到预期的性能和可靠性目标。

---

## 注释

- 所有任务已标记为完成 `[x]`，反映实际实施状态
- 每个任务都引用了对应的需求编号，确保需求覆盖完整性
- 任务按照逻辑顺序组织：核心逻辑 → 网络优化 → 文档配置 → 验证部署
- 测试相关的子任务未标记为可选，因为它们已经完成
- 本任务列表可作为功能实施的完整记录和参考文档
