# 止盈挂单方向自动修复

## 功能说明

系统已集成自动检测和修复错误止盈单的功能，无需手动干预。

## 自动修复机制

系统在每个监控周期（60秒）会自动：

1. **检测止盈单方向**
   - 获取交易所的实际持仓方向
   - 检查止盈单的方向是否正确
   - 做多持仓 → 止盈单应该是 SELL
   - 做空持仓 → 止盈单应该是 BUY

2. **自动修复错误**
   - 如果检测到方向错误，立即取消错误的止盈单
   - 更新持仓方向和数量为实际值
   - 重新创建正确方向的止盈单
   - 发送 Telegram 通知

3. **日志记录**
   ```
   ❌ 检测到止盈单方向错误: BTCUSDT (algoId=12345)
      持仓方向: SHORT, 止盈单方向: SELL, 应该是: BUY
      自动取消并重新创建正确的止盈单
   🗑️ 已取消错误的止盈单: 12345
   ✅ 新止盈单已挂出: BTCUSDT TP=33% @ 95000.0 (algoId=67890)
   ```

## 触发条件

自动修复会在以下情况触发：

1. **监控循环检查**：每60秒检查一次所有持仓
2. **持仓方向不匹配**：程序记录的方向与交易所实际方向不一致
3. **止盈单方向错误**：止盈单的买卖方向与持仓方向不匹配

## 预防措施

系统已在以下位置添加了方向检查：

1. **修改止盈单时** (`_replace_tp_order`)
   - 从交易所获取实际持仓方向
   - 使用实际方向创建新的止盈单

2. **恢复止盈单时** (`_restore_tp_order`)
   - 从交易所获取实际持仓方向
   - 使用实际方向恢复止盈单

3. **监控循环中** (`_check_position`)
   - 定期验证止盈单方向
   - 自动修复错误的止盈单

## 手动修复脚本（备用）

如果需要立即修复所有错误的止盈单，可以运行：

```bash
python scripts/fix_wrong_tp_orders.py
```

但通常不需要，因为系统会在下一个监控周期（最多60秒）自动修复。

## 监控和验证

### 查看自动修复日志

```bash
# 查看止盈单方向错误的检测
grep "止盈单方向错误" logs/duo-live.log

# 查看自动修复记录
grep "已取消错误的止盈单" logs/duo-live.log

# 查看新止盈单创建
grep "新止盈单已挂出" logs/duo-live.log
```

### 验证止盈单正确性

```bash
# 通过 Telegram bot
/orders BTCUSDT

# 或查看 Web 界面
http://your-server:3000/positions
```

## 故障排查

### 问题：系统没有自动修复错误的止盈单

**可能原因**：
1. 系统未重启，旧代码仍在运行
2. 监控循环出现异常

**解决方法**：
```bash
# 1. 重启系统
pm2 restart duo-live-backend

# 2. 查看日志确认监控循环正常
tail -f logs/duo-live.log | grep "检查持仓"

# 3. 如果仍有问题，运行手动修复脚本
python scripts/fix_wrong_tp_orders.py
```

### 问题：修复后又出现错误的止盈单

**可能原因**：
1. 有其他程序在修改订单
2. 手动在币安网页修改了订单

**解决方法**：
1. 停止其他可能修改订单的程序
2. 避免手动修改系统管理的订单
3. 让系统自动管理所有订单

## 相关代码

- 自动修复逻辑：`live/live_position_monitor.py` 第 475-530 行
- 方向检测：`_get_exchange_position_amt()` 方法
- 止盈单替换：`_replace_tp_order()` 方法
- 止盈单恢复：`_restore_tp_order()` 方法

## 通知示例

当检测到并修复错误的止盈单时，会收到 Telegram 通知：

```
⚠️ 止盈单方向错误已修复
  BTCUSDT
  持仓: SHORT
  已重新创建正确的止盈单
```

## 注意事项

1. **自动修复是安全的**：系统会先取消错误订单，再创建正确订单
2. **不会影响持仓**：只修改止盈单，不会平仓或修改持仓
3. **保留止盈百分比**：使用当前的止盈百分比（如33%、21%、10%）
4. **实时生效**：修复后立即生效，无需等待

## 升级说明

如果你的系统是旧版本，需要：

1. 拉取最新代码
   ```bash
   git pull origin main
   ```

2. 重启系统
   ```bash
   pm2 restart duo-live-backend
   ```

3. 观察日志确认功能正常
   ```bash
   tail -f logs/duo-live.log
   ```

---

**自动修复功能已集成到主程序，无需额外配置或手动干预。**
